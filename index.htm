<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Login | SIM Database</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDEJig18F3LY8UOcMa4l7uK9FkGwDYtA2Y",
      authDomain: "sim-database-bf915.firebaseapp.com",
      projectId: "sim-database-bf915",
      storageBucket: "sim-database-bf915.appspot.com",
      messagingSenderId: "609545113124",
      appId: "1:609545113124:web:82c8a19528aa74387d12b1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    document.getElementById("registerBtn").onclick = () => {
      const email = prompt("Enter Email:");
      const password = prompt("Enter Password (6+ chars):");
      if (!email || !password) return alert("Email and password required.");
      createUserWithEmailAndPassword(auth, email, password)
        .then(userCredential => {
          const uid = userCredential.user.uid;
          set(ref(db, 'users/' + uid), {
            email: email,
            approved: false
          });
          alert("Registered. Await admin approval.");
        }).catch(err => alert(err.message));
    };

    document.getElementById("loginBtn").onclick = () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      signInWithEmailAndPassword(auth, email, password)
        .then(userCredential => {
          const uid = userCredential.user.uid;
          get(child(ref(db), 'users/' + uid)).then(snapshot => {
            if (snapshot.exists() && snapshot.val().approved) {
              document.getElementById("loginBox").style.display = "none";
              document.getElementById("appBox").style.display = "block";
            } else {
              signOut(auth);
              alert("Not approved by admin.");
            }
          });
        }).catch(err => alert(err.message));
    };

    document.getElementById("logoutBtn").onclick = () => {
      signOut(auth).then(() => {
        document.getElementById("appBox").style.display = "none";
        document.getElementById("loginBox").style.display = "block";
      });
    };
  </script>
  <style>
    body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
    .centered { max-width: 400px; margin: 50px auto; padding: 20px; background: #fff; border-radius: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
    .record-card { background: #fff; padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <div id="loginBox" class="centered">
    <h3 class="text-center text-primary">ğŸ“± SIM Database Login</h3>
    <input type="email" id="email" class="form-control mb-2" placeholder="Email" />
    <input type="password" id="password" class="form-control mb-2" placeholder="Password" />
    <button class="btn btn-success w-100 mb-2" id="loginBtn">Login</button>
    <button class="btn btn-secondary w-100" id="registerBtn">Register</button>
  </div>

  <div id="appBox" style="display:none;" class="container mt-4">
    <div class="d-flex justify-content-between align-items-center">
      <h4 class="text-primary">ğŸ“± Yasir SIM DATABASE</h4>
      <button class="btn btn-danger btn-sm" id="logoutBtn">Logout</button>
    </div>
    <div class="my-3">
      <input type="text" id="num" class="form-control text-center" placeholder="Enter Number or CNIC" />
      <button id="fetchData" class="btn btn-success w-100 mt-2">Search</button>
    </div>
    <div id="responseBox" class="mt-4 mb-4"></div>
  </div>

  <script>
    document.getElementById("fetchData").addEventListener("click", async () => {
      const input = document.getElementById("num");
      const num = input.value.trim();
      const box = document.getElementById("responseBox");
      box.innerHTML = "<div class='text-center text-muted'>Loading...</div>";
      input.value = "";

      const url = `https://api.allorigins.win/get?url=${encodeURIComponent(`https://freshsimdetails.com/wp-json/sim-search/v1/fetch-data?number=${num}`)}`;
      try {
        const res = await fetch(url);
        const json = await res.json();
        const apiData = JSON.parse(json.contents);
        if (!apiData.name || !apiData.cnic) return box.innerHTML = "âŒ No data found.";

        let html = "";
        if (Array.isArray(apiData.numbers) && apiData.numbers.length > 0) {
          apiData.numbers.forEach(rec => {
            let mobile = typeof rec === 'string' ? rec : rec.mobile || "N/A";
            let operator = rec.operator || apiData.operator || "N/A";
            let address = rec.address || apiData.address || "N/A";
            html += `
              <div class="record-card">
                <strong>ğŸ“ Mobile:</strong> ${mobile}<br>
                <strong>ğŸ‘¤ Name:</strong> ${apiData.name}<br>
                <strong>ğŸ†” CNIC:</strong> ${apiData.cnic}<br>
                <strong>ğŸ  Address:</strong> ${address}<br>
                <strong>ğŸ“¡ Operator:</strong> ${operator}<br>
                <button class="btn btn-outline-primary btn-sm mt-2" onclick="shareRecord(this)">ğŸ“¤ Share</button>
              </div>`;
          });
        } else {
          html = `
            <div class="record-card">
              <strong>ğŸ‘¤ Name:</strong> ${apiData.name}<br>
              <strong>ğŸ†” CNIC:</strong> ${apiData.cnic}<br>
              <strong>ğŸ“ Mobile:</strong> ${apiData.number || "N/A"}<br>
              <strong>ğŸ  Address:</strong> ${apiData.address || "N/A"}<br>
              <strong>ğŸ“¡ Operator:</strong> ${apiData.operator || "N/A"}<br>
              <button class="btn btn-outline-primary btn-sm mt-2" onclick="shareRecord(this)">ğŸ“¤ Share</button>
            </div>`;
        }
        box.innerHTML = html;
      } catch (e) {
        box.innerHTML = `<div class="text-danger">API Error: ${e.message}</div>`;
      }
    });

    function shareRecord(btn) {
      const card = btn.closest(".record-card");
      html2canvas(card).then(canvas => {
        const link = document.createElement("a");
        link.download = "record.png";
        link.href = canvas.toDataURL();
        link.click();
      });
    }
  </script>
</body>
</html>
