<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SIM Database Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
    .centered { max-width: 400px; margin: 50px auto; padding: 30px; background: #fff; border-radius: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
    .hidden { display: none; }
    #responseBox .record-card {
      background: #fff; padding: 15px; margin-bottom: 10px;
      border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

  <div class="centered" id="authBox">
    <h4 class="text-center mb-4">ğŸ” SIM Database Login</h4>
    <input type="email" id="email" class="form-control mb-2" placeholder="Email" />
    <input type="password" id="password" class="form-control mb-2" placeholder="Password" />
    <div class="d-grid gap-2">
      <button id="loginBtn" class="btn btn-primary">Login</button>
      <button id="registerBtn" class="btn btn-secondary">Register</button>
    </div>
    <p class="text-center text-danger mt-2" id="authMsg"></p>
  </div>

  <div class="container hidden" id="mainApp">
    <h3 class="text-center text-primary my-3">ğŸ“± Yasir SIM DATABASE</h3>
    <div class="mb-3">
      <input type="text" id="num" class="form-control text-center" placeholder="Enter Number or CNIC" />
    </div>
    <div class="d-grid gap-2">
      <button id="fetchData" class="btn btn-success">Search</button>
      <button id="logoutBtn" class="btn btn-danger">Logout</button>
    </div>
    <div id="responseBox" class="mt-4 mb-4"></div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDEJig18F3LY8UOcMa4l7uK9FkGwDYtA2Y",
      authDomain: "sim-database-bf915.firebaseapp.com",
      databaseURL: "https://sim-database-bf915-default-rtdb.firebaseio.com",
      projectId: "sim-database-bf915",
      storageBucket: "sim-database-bf915.appspot.com",
      messagingSenderId: "609545113124",
      appId: "1:609545113124:web:82c8a19528aa74387d12b1",
      measurementId: "G-QR3T3WZM0E"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase();

    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const loginBtn = document.getElementById("loginBtn");
    const registerBtn = document.getElementById("registerBtn");
    const authMsg = document.getElementById("authMsg");
    const authBox = document.getElementById("authBox");
    const mainApp = document.getElementById("mainApp");
    const logoutBtn = document.getElementById("logoutBtn");

    registerBtn.onclick = () => {
      const email = emailInput.value;
      const password = passwordInput.value;
      createUserWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          const uid = userCredential.user.uid;
          set(ref(db, 'users/' + uid), {
            email: email,
            registeredAt: new Date().toISOString()
          });
          authMsg.textContent = "âœ… Registered successfully. Please login.";
        })
        .catch((error) => {
          authMsg.textContent = error.message;
        });
    };

    loginBtn.onclick = () => {
      const email = emailInput.value;
      const password = passwordInput.value;
      signInWithEmailAndPassword(auth, email, password)
        .then(() => {
          authBox.classList.add("hidden");
          mainApp.classList.remove("hidden");
        })
        .catch((error) => {
          authMsg.textContent = error.message;
        });
    };

    logoutBtn.onclick = () => {
      signOut(auth).then(() => {
        mainApp.classList.add("hidden");
        authBox.classList.remove("hidden");
      });
    };

    // SIM Search Function
    document.getElementById("fetchData").addEventListener("click", async () => {
      const input = document.getElementById("num");
      const num = input.value.trim();
      const box = document.getElementById("responseBox");
      box.innerHTML = "<div class='text-center text-muted'>Loading...</div>";
      input.value = "";

      const url = `https://api.allorigins.win/get?url=${encodeURIComponent(`https://freshsimdetails.com/wp-json/sim-search/v1/fetch-data?number=${num}`)}`;
      try {
        const res = await fetch(url);
        const json = await res.json();
        const apiData = JSON.parse(json.contents);
        if (!apiData.name || !apiData.cnic) return box.innerHTML = "âŒ No data found.";

        let html = "";
        if (Array.isArray(apiData.numbers) && apiData.numbers.length > 0) {
          apiData.numbers.forEach(rec => {
            let mobile = typeof rec === 'string' ? rec : rec.mobile || "N/A";
            let operator = rec.operator || apiData.operator || "N/A";
            let address = rec.address || apiData.address || "N/A";
            html += `
              <div class="record-card">
                <strong>ğŸ“ Mobile:</strong> ${mobile}<br>
                <strong>ğŸ‘¤ Name:</strong> ${apiData.name}<br>
                <strong>ğŸ†” CNIC:</strong> ${apiData.cnic}<br>
                <strong>ğŸ  Address:</strong> ${address}<br>
                <strong>ğŸ“¡ Operator:</strong> ${operator}<br>
                <button class="btn btn-outline-primary btn-sm mt-2" onclick="shareRecord(this)">ğŸ“¤ Share</button>
              </div>`;
          });
        } else {
          html = `
            <div class="record-card">
              <strong>ğŸ‘¤ Name:</strong> ${apiData.name}<br>
              <strong>ğŸ†” CNIC:</strong> ${apiData.cnic}<br>
              <strong>ğŸ“ Mobile:</strong> ${apiData.number || "N/A"}<br>
              <strong>ğŸ  Address:</strong> ${apiData.address || "N/A"}<br>
              <strong>ğŸ“¡ Operator:</strong> ${apiData.operator || "N/A"}<br>
              <button class="btn btn-outline-primary btn-sm mt-2" onclick="shareRecord(this)">ğŸ“¤ Share</button>
            </div>`;
        }
        box.innerHTML = html;
      } catch (e) {
        box.innerHTML = `<div class="text-danger">API Error: ${e.message}</div>`;
      }
    });

    // Share Record
    window.shareRecord = function (btn) {
      html2canvas(btn.parentElement).then(canvas => {
        const link = document.createElement("a");
        link.href = canvas.toDataURL("image/png");
        link.download = "sim_record.png";
        link.click();
      });
    };
  </script>
</body>
</html>
